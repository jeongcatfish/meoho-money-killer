//@version=5
strategy("OB + FVG + Trap Strategy v2 (Long/Short, ATR-based TP/SL)",
     overlay=true,
     initial_capital=1000,
     commission_type=strategy.commission.percent,
     commission_value=0.04,
     slippage=2,
     pyramiding=0,
     process_orders_on_close=false,
     default_qty_type=strategy.cash,
     default_qty_value=100)

// ===== Direction Inputs =====
useLong  = input.bool(true,  "Enable Long",  group="Direction")
useShort = input.bool(true,  "Enable Short", group="Direction")
minConfirms = input.int(2, "Min confirmations (2-of-3)", minval=1, maxval=3, group="Direction")

// ===== Trend Filter =====
useTrendFilter = input.bool(true, "Use EMA trend filter", group="Trend Filter")
emaLen         = input.int(200, "EMA length", minval=1, group="Trend Filter")
useHTFEMA      = input.bool(true, "Use HTF EMA filter", group="Trend Filter")
htf            = input.timeframe("240", "HTF for EMA", group="Trend Filter")

// ===== Structure Settings =====
swingLen       = input.int(10, "Swing detection length", minval=3, group="Structure")
obMaxAge       = input.int(100, "OB max age (bars)", minval=10, group="Structure")
fvgMaxAge      = input.int(100, "FVG max age (bars)", minval=10, group="Structure")
channelLen     = input.int(55, "Channel length (trap)", minval=5, group="Structure")

// ===== Volatility Filter =====
atrLen     = input.int(14, "ATR length", minval=1, group="Volatility")
minAtrPct  = input.float(0.15, "Min ATR% filter", minval=0.0, step=0.01, group="Volatility")

// ===== Risk Management (ATR-based) =====
slAtrMult  = input.float(1.5, "SL ATR multiplier", minval=0.5, step=0.1, group="Risk Management")
tpAtrMult  = input.float(2.5, "TP ATR multiplier", minval=0.5, step=0.1, group="Risk Management")
riskPct    = input.float(1.0, "Risk % of equity per trade", minval=0.1, step=0.1, group="Risk Management")
maxQty     = input.float(0.0, "Max position size (0 = no cap)", minval=0.0, group="Risk Management")

// ===== Cooldown =====
useCooldown  = input.bool(true, "Use cooldown bars after exit", group="Cooldown")
cooldownBars = input.int(5, "Cooldown bars", minval=0, group="Cooldown")

// ===== Calculations =====
atr    = ta.atr(atrLen)
atrPct = atr / close * 100.0
volOK  = atrPct >= minAtrPct

// ===== Trend Filter =====
ema    = ta.ema(close, emaLen)
emaHTF = request.security(syminfo.tickerid, htf, ta.ema(close, emaLen)[1], barmerge.gaps_off, barmerge.lookahead_on)

trendLongOK  = (not useTrendFilter or close >= ema) and (not useHTFEMA or close >= emaHTF)
trendShortOK = (not useTrendFilter or close <= ema) and (not useHTFEMA or close <= emaHTF)

// ===== Swing High/Low Detection =====
swingHigh = ta.pivothigh(high, swingLen, swingLen)
swingLow  = ta.pivotlow(low, swingLen, swingLen)

// ===== Order Block (Improved) =====
// Bullish OB: 스윙 저점 이후 강한 상승 캔들 (이전 음봉을 감싸는)
// Bearish OB: 스윙 고점 이후 강한 하락 캔들 (이전 양봉을 감싸는)

var float bullObHigh = na
var float bullObLow  = na
var int   bullObBar  = na
var bool  bullObLive = false

var float bearObHigh = na
var float bearObLow  = na
var int   bearObBar  = na
var bool  bearObLive = false

// Bullish OB: 스윙 저점 근처에서 형성된 강한 상승 캔들
recentSwingLow = ta.valuewhen(not na(swingLow), swingLow, 0)
nearSwingLow   = not na(recentSwingLow) and low <= recentSwingLow * 1.01

bullObSignal = close > open and                    // 양봉
               close[1] < open[1] and              // 이전 음봉
               close > high[1] and                 // 이전 고점 돌파
               (close - open) > atr * 0.5 and     // 강한 몸통
               (bar_index - ta.valuewhen(not na(swingLow), bar_index, 0) <= swingLen * 2)  // 스윙 저점 근처

if bullObSignal
    bullObHigh := high[1]
    bullObLow  := low[1]
    bullObBar  := bar_index
    bullObLive := true

// Bearish OB: 스윙 고점 근처에서 형성된 강한 하락 캔들
recentSwingHigh = ta.valuewhen(not na(swingHigh), swingHigh, 0)
nearSwingHigh   = not na(recentSwingHigh) and high >= recentSwingHigh * 0.99

bearObSignal = close < open and                    // 음봉
               close[1] > open[1] and              // 이전 양봉
               close < low[1] and                  // 이전 저점 돌파
               (open - close) > atr * 0.5 and     // 강한 몸통
               (bar_index - ta.valuewhen(not na(swingHigh), bar_index, 0) <= swingLen * 2)  // 스윙 고점 근처

if bearObSignal
    bearObHigh := high[1]
    bearObLow  := low[1]
    bearObBar  := bar_index
    bearObLive := true

// OB Validity
bullObValid = bullObLive and not na(bullObHigh) and (bar_index - bullObBar <= obMaxAge)
bearObValid = bearObLive and not na(bearObHigh) and (bar_index - bearObBar <= obMaxAge)

// Price in OB zone (retest)
inBullOb = bullObValid and low <= bullObHigh and close > bullObLow
inBearOb = bearObValid and high >= bearObLow and close < bearObHigh

// OB Mitigation (invalidation)
if bullObValid and close < bullObLow and close[1] < bullObLow
    bullObLive := false

if bearObValid and close > bearObHigh and close[1] > bearObHigh
    bearObLive := false

// ===== Fair Value Gap (Improved) =====
var float bullFvgHigh = na
var float bullFvgLow  = na
var int   bullFvgBar  = na
var bool  bullFvgLive = false

var float bearFvgHigh = na
var float bearFvgLow  = na
var int   bearFvgBar  = na
var bool  bearFvgLive = false

// Bullish FVG: 갭 상승 (현재 저점 > 2봉전 고점)
bullFvgSignal = bar_index >= 2 and low > high[2] and (low - high[2]) > atr * 0.1

if bullFvgSignal
    bullFvgHigh := low       // 갭 상단
    bullFvgLow  := high[2]   // 갭 하단
    bullFvgBar  := bar_index
    bullFvgLive := true

// Bearish FVG: 갭 하락 (현재 고점 < 2봉전 저점)
bearFvgSignal = bar_index >= 2 and high < low[2] and (low[2] - high) > atr * 0.1

if bearFvgSignal
    bearFvgHigh := low[2]    // 갭 상단
    bearFvgLow  := high      // 갭 하단
    bearFvgBar  := bar_index
    bearFvgLive := true

// FVG Validity
bullFvgValid = bullFvgLive and not na(bullFvgHigh) and (bar_index - bullFvgBar <= fvgMaxAge)
bearFvgValid = bearFvgLive and not na(bearFvgHigh) and (bar_index - bearFvgBar <= fvgMaxAge)

// Price retesting FVG
inBullFvg = bullFvgValid and low <= bullFvgHigh and close > bullFvgLow
inBearFvg = bearFvgValid and high >= bearFvgLow and close < bearFvgHigh

// FVG Mitigation
if bullFvgValid and close < bullFvgLow and close[1] < bullFvgLow
    bullFvgLive := false

if bearFvgValid and close > bearFvgHigh and close[1] > bearFvgHigh
    bearFvgLive := false

// ===== Trap Detection (Corrected terminology) =====
chUpper = ta.highest(high, channelLen)[1]
chLower = ta.lowest(low, channelLen)[1]

// Bear Trap: 하단 이탈 후 회복 (매수 신호)
bearTrap = not na(chLower) and low < chLower and close > chLower

// Bull Trap: 상단 돌파 후 실패 (매도 신호)
bullTrap = not na(chUpper) and high > chUpper and close < chUpper

// ===== Rejection Candle =====
// Bullish rejection: 하락 시도 후 반등 (긴 아래꼬리)
lowerWick     = math.min(open, close) - low
upperWick     = high - math.max(open, close)
body          = math.abs(close - open)
candleRange   = high - low

bullReject = candleRange > 0 and
             (lowerWick / candleRange > 0.5) and
             close > open and
             close > (high + low) / 2

// Bearish rejection: 상승 시도 후 하락 (긴 위꼬리)
bearReject = candleRange > 0 and
             (upperWick / candleRange > 0.5) and
             close < open and
             close < (high + low) / 2

// ===== Confirmation Count =====
longConf = (inBullOb  ? 1 : 0) +
           (inBullFvg ? 1 : 0) +
           (bearTrap  ? 1 : 0)   // Bear Trap = 롱 신호

shortConf = (inBearOb  ? 1 : 0) +
            (inBearFvg ? 1 : 0) +
            (bullTrap  ? 1 : 0)  // Bull Trap = 숏 신호

canLong = useLong and
          volOK and
          trendLongOK and
          (longConf >= minConfirms) and
          bullReject

canShort = useShort and
           volOK and
           trendShortOK and
           (shortConf >= minConfirms) and
           bearReject

// ===== Cooldown after exit =====
var int lastFlatBar = na
if strategy.position_size == 0 and strategy.position_size[1] != 0
    lastFlatBar := bar_index

cooldownOK = not useCooldown or
             na(lastFlatBar) or
             (bar_index - lastFlatBar >= cooldownBars)

// ===== Position Sizing =====
riskAmount = strategy.equity * (riskPct / 100.0)

// ===== Long Entry =====
if cooldownOK and canLong and strategy.position_size == 0
    entry     = close
    stopLong  = entry - (atr * slAtrMult)
    limitLong = entry + (atr * tpAtrMult)
    stopDist  = entry - stopLong

    if stopDist > syminfo.mintick
        qty = riskAmount / stopDist
        qty := maxQty > 0 ? math.min(qty, maxQty) : qty

        if qty > 0
            strategy.entry("Long", strategy.long, qty=qty)
            strategy.exit("Long Exit", "Long", stop=stopLong, limit=limitLong)

// ===== Short Entry =====
if cooldownOK and canShort and strategy.position_size == 0
    entry      = close
    stopShort  = entry + (atr * slAtrMult)
    limitShort = entry - (atr * tpAtrMult)
    stopDist   = stopShort - entry

    if stopDist > syminfo.mintick
        qty = riskAmount / stopDist
        qty := maxQty > 0 ? math.min(qty, maxQty) : qty

        if qty > 0
            strategy.entry("Short", strategy.short, qty=qty)
            strategy.exit("Short Exit", "Short", stop=stopShort, limit=limitShort)

// ===== Visuals =====
// Trend EMAs
plot(useTrendFilter ? ema : na, "EMA", color=color.blue, linewidth=2)
plot(useHTFEMA ? emaHTF : na, "HTF EMA", color=color.purple, linewidth=2)

// Channel
plot(chUpper, "Channel Upper", color=color.new(color.gray, 70))
plot(chLower, "Channel Lower", color=color.new(color.gray, 70))

// Order Blocks
obBullColor = color.new(color.green, 80)
obBearColor = color.new(color.red, 80)

plot(bullObValid ? bullObHigh : na, "Bull OB High", color=obBullColor, style=plot.style_linebr, linewidth=2)
plot(bullObValid ? bullObLow  : na, "Bull OB Low",  color=obBullColor, style=plot.style_linebr, linewidth=2)
plot(bearObValid ? bearObHigh : na, "Bear OB High", color=obBearColor, style=plot.style_linebr, linewidth=2)
plot(bearObValid ? bearObLow  : na, "Bear OB Low",  color=obBearColor, style=plot.style_linebr, linewidth=2)

// FVG
fvgBullColor = color.new(color.teal, 80)
fvgBearColor = color.new(color.orange, 80)

plot(bullFvgValid ? bullFvgHigh : na, "Bull FVG High", color=fvgBullColor, style=plot.style_linebr)
plot(bullFvgValid ? bullFvgLow  : na, "Bull FVG Low",  color=fvgBullColor, style=plot.style_linebr)
plot(bearFvgValid ? bearFvgHigh : na, "Bear FVG High", color=fvgBearColor, style=plot.style_linebr)
plot(bearFvgValid ? bearFvgLow  : na, "Bear FVG Low",  color=fvgBearColor, style=plot.style_linebr)

// Entry Signals
plotshape(cooldownOK and canLong and strategy.position_size == 0,
     title="Long Signal",
     style=shape.triangleup,
     color=color.green,
     size=size.small,
     location=location.belowbar)

plotshape(cooldownOK and canShort and strategy.position_size == 0,
     title="Short Signal",
     style=shape.triangledown,
     color=color.red,
     size=size.small,
     location=location.abovebar)

// ===== Info Table =====
var table infoTable = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 80))

if barstate.islast
    table.cell(infoTable, 0, 0, "Metric", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Value", text_color=color.white, text_size=size.small)

    table.cell(infoTable, 0, 1, "ATR%", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(atrPct, "#.##") + "%", text_color=volOK ? color.green : color.red, text_size=size.small)

    table.cell(infoTable, 0, 2, "Trend (LTF)", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 2, close >= ema ? "Bull" : "Bear", text_color=close >= ema ? color.green : color.red, text_size=size.small)

    table.cell(infoTable, 0, 3, "Trend (HTF)", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 3, close >= emaHTF ? "Bull" : "Bear", text_color=close >= emaHTF ? color.green : color.red, text_size=size.small)

    table.cell(infoTable, 0, 4, "Long Conf", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(longConf) + "/3", text_color=longConf >= minConfirms ? color.green : color.gray, text_size=size.small)

    table.cell(infoTable, 0, 5, "Short Conf", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 5, str.tostring(shortConf) + "/3", text_color=shortConf >= minConfirms ? color.red : color.gray, text_size=size.small)

    table.cell(infoTable, 0, 6, "Bull OB", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 6, bullObValid ? "Active" : "None", text_color=bullObValid ? color.green : color.gray, text_size=size.small)

    table.cell(infoTable, 0, 7, "Bear OB", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 7, bearObValid ? "Active" : "None", text_color=bearObValid ? color.red : color.gray, text_size=size.small)
