//@version=5
strategy("Crypto Trend Breakout",
     overlay=true,
     initial_capital=1000,
     commission_type=strategy.commission.percent,
     commission_value=0.04,
     slippage=3,
     pyramiding=0,
     process_orders_on_close=false,
     calc_on_every_tick=false)

// ============================================================================
// STRATEGY CONCEPT
// ============================================================================
// 코인 특화 트렌드 추종 브레이크아웃 전략
//
// 핵심 원리:
// 1. 코인은 트렌드가 길고 강하다 → 트렌드 추종
// 2. Donchian Channel 돌파 = 검증된 브레이크아웃 시스템 (터틀 트레이딩)
// 3. EMA 필터로 역추세 진입 방지
// 4. 볼륨 확인으로 거짓 돌파 필터링
// 5. 트레일링 스탑으로 큰 움직임 수익화
//
// 코인에 적합한 이유:
// - 트렌드 시장에서 효과적
// - 오버트레이딩 방지 (신호 빈도 적절)
// - 변동성에 적응하는 ATR 기반 청산
// ============================================================================

// ===== Direction =====
useLong  = input.bool(true, "Enable Long", group="Direction")
useShort = input.bool(true, "Enable Short", group="Direction")

// ===== Donchian Channel (Breakout) =====
doncLen    = input.int(20, "Donchian Length", minval=5, group="Breakout")
useClose   = input.bool(true, "Use Close for Breakout (safer)", group="Breakout")

// ===== Trend Filter =====
useTrend   = input.bool(true, "Use EMA Trend Filter", group="Trend")
emaFast    = input.int(21, "Fast EMA", minval=5, group="Trend")
emaSlow    = input.int(55, "Slow EMA", minval=10, group="Trend")
emaLong    = input.int(200, "Long EMA (Major Trend)", minval=50, group="Trend")

// ===== Volume Filter =====
useVol     = input.bool(true, "Use Volume Filter", group="Volume")
volLen     = input.int(20, "Volume MA Length", minval=5, group="Volume")
volMult    = input.float(1.0, "Volume Threshold (x avg)", minval=0.5, step=0.1, group="Volume")

// ===== Risk Management =====
slAtrMult  = input.float(2.0, "Initial SL (ATR mult)", minval=0.5, step=0.1, group="Risk")
useTrail   = input.bool(true, "Use Trailing Stop", group="Risk")
trailAtr   = input.float(3.0, "Trailing Stop (ATR mult)", minval=1.0, step=0.1, group="Risk")
riskPct    = input.float(2.0, "Risk % per Trade", minval=0.1, step=0.1, group="Risk")

// ===== Exit =====
useTimeExit = input.bool(false, "Use Time-based Exit", group="Exit")
maxBars     = input.int(50, "Max Bars in Trade", minval=10, group="Exit")

// ===== Filter =====
cooldownBars = input.int(2, "Cooldown Bars after Exit", minval=0, group="Filter")
atrLen       = input.int(14, "ATR Length", minval=5, group="Filter")

// ===== Calculations =====
atr = ta.atr(atrLen)

// ----- Donchian Channel -----
doncUpper = ta.highest(high, doncLen)[1]  // 이전 봉까지의 고점
doncLower = ta.lowest(low, doncLen)[1]    // 이전 봉까지의 저점
doncMid   = (doncUpper + doncLower) / 2

// ----- Breakout Detection -----
breakoutUp   = useClose ? close > doncUpper : high > doncUpper
breakoutDown = useClose ? close < doncLower : low < doncLower

// ----- EMA Trend -----
emaF = ta.ema(close, emaFast)
emaS = ta.ema(close, emaSlow)
emaL = ta.ema(close, emaLong)

// 트렌드 조건
// - Fast > Slow = 단기 상승
// - Price > 200 EMA = 장기 상승
trendUp   = emaF > emaS and close > emaL
trendDown = emaF < emaS and close < emaL

trendOkLong  = not useTrend or trendUp
trendOkShort = not useTrend or trendDown

// ----- Volume Filter -----
volMA  = ta.sma(volume, volLen)
volOK  = not useVol or volume >= volMA * volMult

// ----- Entry Conditions -----
longCond  = useLong and breakoutUp and trendOkLong and volOK
shortCond = useShort and breakoutDown and trendOkShort and volOK

// ----- Cooldown -----
var int lastExitBar = na
if strategy.position_size == 0 and strategy.position_size[1] != 0
    lastExitBar := bar_index

cooldownOk = na(lastExitBar) or (bar_index - lastExitBar >= cooldownBars)

// ----- Position Sizing -----
riskAmount = strategy.equity * (riskPct / 100.0)

// ----- Track Entry Bar -----
var int entryBar = na

// ===== Long Entry =====
if cooldownOk and longCond and strategy.position_size == 0
    entryPrice = close
    stopLoss   = entryPrice - (atr * slAtrMult)
    stopDist   = entryPrice - stopLoss

    if stopDist > syminfo.mintick
        qty = riskAmount / stopDist
        qty := math.max(qty, syminfo.mintick)

        strategy.entry("Long", strategy.long, qty=qty)
        entryBar := bar_index

        if useTrail
            // 트레일링 스탑만 사용 (TP 없음 - 트렌드를 끝까지 탄다)
            strategy.exit("Long Exit", "Long",
                 stop=stopLoss,
                 trail_points=atr * trailAtr / syminfo.mintick,
                 trail_offset=atr * trailAtr / syminfo.mintick)
        else
            strategy.exit("Long Exit", "Long", stop=stopLoss)

// ===== Short Entry =====
if cooldownOk and shortCond and strategy.position_size == 0
    entryPrice = close
    stopLoss   = entryPrice + (atr * slAtrMult)
    stopDist   = stopLoss - entryPrice

    if stopDist > syminfo.mintick
        qty = riskAmount / stopDist
        qty := math.max(qty, syminfo.mintick)

        strategy.entry("Short", strategy.short, qty=qty)
        entryBar := bar_index

        if useTrail
            strategy.exit("Short Exit", "Short",
                 stop=stopLoss,
                 trail_points=atr * trailAtr / syminfo.mintick,
                 trail_offset=atr * trailAtr / syminfo.mintick)
        else
            strategy.exit("Short Exit", "Short", stop=stopLoss)

// ===== Time-based Exit =====
if useTimeExit and strategy.position_size != 0
    barsInTrade = bar_index - entryBar
    if barsInTrade >= maxBars
        strategy.close_all("Time Exit")

// ===== Visuals =====
// Donchian Channel
plot(doncUpper, "Donchian Upper", color=color.new(color.green, 30), linewidth=2)
plot(doncLower, "Donchian Lower", color=color.new(color.red, 30), linewidth=2)
plot(doncMid, "Donchian Mid", color=color.new(color.gray, 50), style=plot.style_linebr)

// EMAs
plot(useTrend ? emaF : na, "EMA Fast", color=color.new(color.yellow, 0), linewidth=1)
plot(useTrend ? emaS : na, "EMA Slow", color=color.new(color.orange, 0), linewidth=1)
plot(useTrend ? emaL : na, "EMA 200", color=color.new(color.white, 0), linewidth=2)

// Trend Background
bgcolor(trendUp ? color.new(color.green, 92) : trendDown ? color.new(color.red, 92) : na)

// Entry Signals
plotshape(longCond and cooldownOk and strategy.position_size == 0,
     title="Long Signal",
     style=shape.triangleup,
     color=color.lime,
     size=size.normal,
     location=location.belowbar)

plotshape(shortCond and cooldownOk and strategy.position_size == 0,
     title="Short Signal",
     style=shape.triangledown,
     color=color.red,
     size=size.normal,
     location=location.abovebar)

// Breakout Markers
plotshape(breakoutUp and not breakoutUp[1],
     title="Breakout Up",
     style=shape.circle,
     color=color.new(color.green, 50),
     size=size.tiny,
     location=location.abovebar)

plotshape(breakoutDown and not breakoutDown[1],
     title="Breakout Down",
     style=shape.circle,
     color=color.new(color.red, 50),
     size=size.tiny,
     location=location.belowbar)

// ===== Info Table =====
var table infoTable = table.new(position.top_right, 2, 7, bgcolor=color.new(color.black, 80))

if barstate.islast
    table.cell(infoTable, 0, 0, "Metric", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Value", text_color=color.white, text_size=size.small)

    // Trend
    trendText = trendUp ? "BULLISH" : trendDown ? "BEARISH" : "NEUTRAL"
    trendCol  = trendUp ? color.lime : trendDown ? color.red : color.gray
    table.cell(infoTable, 0, 1, "Trend", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 1, trendText, text_color=trendCol, text_size=size.small)

    // Donchian Levels
    table.cell(infoTable, 0, 2, "Donchian High", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(doncUpper, "#.##"), text_color=color.green, text_size=size.small)

    table.cell(infoTable, 0, 3, "Donchian Low", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(doncLower, "#.##"), text_color=color.red, text_size=size.small)

    // Volume
    volStatus = volume >= volMA * volMult ? "HIGH" : "LOW"
    volCol    = volume >= volMA * volMult ? color.lime : color.gray
    table.cell(infoTable, 0, 4, "Volume", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 4, volStatus, text_color=volCol, text_size=size.small)

    // ATR %
    atrPct = atr / close * 100
    table.cell(infoTable, 0, 5, "ATR%", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 5, str.tostring(atrPct, "#.##") + "%", text_color=color.white, text_size=size.small)

    // Position
    posText = strategy.position_size > 0 ? "LONG" : strategy.position_size < 0 ? "SHORT" : "FLAT"
    posCol  = strategy.position_size > 0 ? color.lime : strategy.position_size < 0 ? color.red : color.gray
    table.cell(infoTable, 0, 6, "Position", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 6, posText, text_color=posCol, text_size=size.small)

// ===== Alerts =====
alertcondition(longCond and cooldownOk, "Long Entry", "Trend Breakout: Long Signal")
alertcondition(shortCond and cooldownOk, "Short Entry", "Trend Breakout: Short Signal")
