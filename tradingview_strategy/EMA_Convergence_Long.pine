//@version=5
strategy("EMA 수렴 Spot Long Strategy",
         overlay=true,
         initial_capital=10000,
         default_qty_type=strategy.percent_of_equity,
         default_qty_value=100,
         commission_type=strategy.commission.percent,
         commission_value=0.1,
         pyramiding=0)

// ============================================================================
// EMA 설정
// ============================================================================
len1 = input.int(20, "EMA 1 (빠름)", group="EMA")
len2 = input.int(60, "EMA 2", group="EMA")
len3 = input.int(120, "EMA 3", group="EMA")
len4 = input.int(200, "EMA 4 (느림)", group="EMA")

// ============================================================================
// 수렴 설정
// ============================================================================
compressionThreshold = input.float(1.5, "수렴 기준 (%)", minval=0.1, step=0.1, group="수렴 조건", tooltip="EMA들 사이 거리가 이 % 이하면 수렴")
slopeLen = input.int(3, "기울기 계산 기간", minval=1, group="수렴 조건")

// ============================================================================
// 횡보 필터 (Choppiness Index)
// ============================================================================
useCiFilter = input.bool(true, "CI 필터 사용", group="횡보 필터")
ciLen = input.int(14, "CI 기간", group="횡보 필터")
ciThreshold = input.float(61.8, "CI 횡보 기준 (이상이면 횡보)", group="횡보 필터")

// ============================================================================
// 리스크 관리
// ============================================================================
slMethod = input.string("ATR", "손절 방식", options=["ATR", "PERC"], group="리스크 관리")
slPerc = input.float(2.0, "손절 %", minval=0.5, step=0.5, group="리스크 관리")
slAtrMult = input.float(2.0, "손절 ATR 배수", minval=0.5, step=0.5, group="리스크 관리")

tpMethod = input.string("ATR", "익절 방식", options=["ATR", "PERC"], group="리스크 관리")
tpPerc = input.float(5.0, "익절 %", minval=0.5, step=0.5, group="리스크 관리")
tpAtrMult = input.float(3.0, "익절 ATR 배수", minval=0.5, step=0.5, group="리스크 관리")

useTrailing = input.bool(true, "트레일링 스탑", group="리스크 관리")
trailPerc = input.float(2.0, "트레일링 %", minval=0.5, step=0.5, group="리스크 관리")

atrLen = input.int(14, "ATR 기간", group="리스크 관리")

// ============================================================================
// 계산
// ============================================================================
ema1 = ta.ema(close, len1)
ema2 = ta.ema(close, len2)
ema3 = ta.ema(close, len3)
ema4 = ta.ema(close, len4)
atr = ta.atr(atrLen)

// 수렴 조건: 모든 EMA 사이 거리가 threshold 이하
maxEma = math.max(ema1, ema2, ema3, ema4)
minEma = math.min(ema1, ema2, ema3, ema4)
spread = maxEma - minEma
thresholdValue = ema4 * (compressionThreshold / 100)
isCompressed = spread < thresholdValue

// 수렴 '시작' 감지 (이전 봉에선 수렴 아니었는데 지금 수렴)
convergenceStart = isCompressed and not isCompressed[1]

// EMA 200 기울기 (상승 중인지)
ema4Rising = ema4 > ema4[slopeLen]

// Choppiness Index 계산
ci_atr = ta.atr(1)
ci_sum_atr = math.sum(ci_atr, ciLen)
ci_hh = ta.highest(high, ciLen)
ci_ll = ta.lowest(low, ciLen)
ci_val = 100 * math.log10(ci_sum_atr / (ci_hh - ci_ll)) / math.log10(ciLen)

// 횡보 필터
isTrending = not useCiFilter or ci_val < ciThreshold

// 추가 필터: 가격이 EMA 200 위에 있어야
priceAboveEma = close > ema4

// ============================================================================
// 진입 조건
// ============================================================================
longCondition = convergenceStart and ema4Rising and isTrending and priceAboveEma and strategy.position_size == 0

// ============================================================================
// 실행
// ============================================================================
var float entryPrice = na
var float stopLoss = na
var float takeProfit = na

if longCondition
    entryPrice := close

    // SL 계산
    if slMethod == "ATR"
        stopLoss := close - atr * slAtrMult
    else
        stopLoss := close * (1 - slPerc / 100)

    // TP 계산
    if tpMethod == "ATR"
        takeProfit := close + atr * tpAtrMult
    else
        takeProfit := close * (1 + tpPerc / 100)

    strategy.entry("Long", strategy.long)

// Exit
if strategy.position_size > 0
    if useTrailing
        trailPoints = trailPerc * close / syminfo.mintick / 100
        trailOffset = trailPerc * 0.3 * close / syminfo.mintick / 100
        strategy.exit("Exit", "Long", stop=stopLoss, limit=takeProfit, trail_points=trailPoints, trail_offset=trailOffset)
    else
        strategy.exit("Exit", "Long", stop=stopLoss, limit=takeProfit)

// ============================================================================
// 시각화
// ============================================================================
plot(ema1, "EMA 20", color=color.blue)
plot(ema2, "EMA 60", color=color.orange)
plot(ema3, "EMA 120", color=color.purple)
plot(ema4, "EMA 200", color=color.red, linewidth=2)

// 수렴 구간 배경
bgcolor(isCompressed ? color.new(color.yellow, 90) : na, title="수렴 구간")

// 횡보 구간 배경
bgcolor(useCiFilter and ci_val >= ciThreshold ? color.new(color.red, 95) : na, title="횡보 구간")

// 진입 신호
plotshape(longCondition, "Entry", shape.triangleup, location.belowbar, color.green, size=size.small)

// SL 라인
plot(strategy.position_size > 0 ? stopLoss : na, "Stop Loss", color=color.red, style=plot.style_linebr, linewidth=2)
plot(strategy.position_size > 0 ? takeProfit : na, "Take Profit", color=color.green, style=plot.style_linebr, linewidth=2)

// ============================================================================
// 정보 테이블
// ============================================================================
var table infoTable = table.new(position.top_right, 2, 5, bgcolor=color.new(color.black, 80))

if barstate.islast
    spreadPct = spread / ema4 * 100

    table.cell(infoTable, 0, 0, "EMA Spread", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 0, str.tostring(spreadPct, "#.##") + "%", text_color=isCompressed ? color.yellow : color.white, text_size=size.small)

    table.cell(infoTable, 0, 1, "수렴 기준", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(compressionThreshold) + "%", text_color=color.white, text_size=size.small)

    table.cell(infoTable, 0, 2, "CI", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(ci_val, "#.#"), text_color=ci_val < ciThreshold ? color.green : color.red, text_size=size.small)

    table.cell(infoTable, 0, 3, "EMA200 방향", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 3, ema4Rising ? "상승" : "하락", text_color=ema4Rising ? color.green : color.red, text_size=size.small)

    table.cell(infoTable, 0, 4, "Position", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 4, strategy.position_size > 0 ? "LONG" : "FLAT", text_color=strategy.position_size > 0 ? color.green : color.gray, text_size=size.small)

// ============================================================================
// 알림
// ============================================================================
alertcondition(longCondition, "EMA 수렴 롱", "EMA Convergence Long Signal")
