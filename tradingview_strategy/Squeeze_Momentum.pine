//@version=5
strategy("Squeeze Momentum Breakout",
     overlay=true,
     initial_capital=1000,
     commission_type=strategy.commission.percent,
     commission_value=0.04,
     slippage=2,
     pyramiding=0,
     process_orders_on_close=false)

// ============================================================================
// STRATEGY CONCEPT
// ============================================================================
// 변동성 수축(Squeeze) 후 확장 시 모멘텀 방향으로 진입
//
// 원리:
// 1. 볼린저 밴드가 켈트너 채널 안으로 수축하면 "스퀴즈" 상태
// 2. 스퀴즈가 풀리는 순간 = 변동성 폭발 시작
// 3. 모멘텀 방향(Linear Regression 기울기)으로 진입
// 4. 추세 필터 + ATR 기반 리스크 관리
//
// 장점:
// - 검증된 개념 (TTM Squeeze 기반)
// - 파라미터 적음 → 과최적화 위험 낮음
// - 변동성 사이클 활용
// ============================================================================

// ===== Inputs =====
// Direction
useLong  = input.bool(true, "Enable Long", group="Direction")
useShort = input.bool(true, "Enable Short", group="Direction")

// Squeeze Detection
bbLen    = input.int(20, "Bollinger Band Length", minval=5, group="Squeeze")
bbMult   = input.float(2.0, "BB StdDev Multiplier", minval=0.5, step=0.1, group="Squeeze")
kcLen    = input.int(20, "Keltner Channel Length", minval=5, group="Squeeze")
kcMult   = input.float(1.5, "KC ATR Multiplier", minval=0.5, step=0.1, group="Squeeze")

// Momentum
momLen   = input.int(12, "Momentum Length", minval=5, group="Momentum")

// Trend Filter
useTrend = input.bool(true, "Use Trend Filter", group="Trend Filter")
trendLen = input.int(50, "Trend EMA Length", minval=10, group="Trend Filter")

// Risk Management
slAtrMult = input.float(2.0, "SL ATR Multiplier", minval=0.5, step=0.1, group="Risk")
tpAtrMult = input.float(3.0, "TP ATR Multiplier", minval=0.5, step=0.1, group="Risk")
useTrail  = input.bool(true, "Use Trailing Stop", group="Risk")
trailAtr  = input.float(2.5, "Trail ATR Multiplier", minval=0.5, step=0.1, group="Risk")
riskPct   = input.float(1.0, "Risk % per Trade", minval=0.1, step=0.1, group="Risk")

// Cooldown
cooldownBars = input.int(3, "Cooldown Bars", minval=0, group="Filter")

// ===== Calculations =====
atr = ta.atr(14)

// ----- Bollinger Bands -----
bbBasis = ta.sma(close, bbLen)
bbDev   = ta.stdev(close, bbLen) * bbMult
bbUpper = bbBasis + bbDev
bbLower = bbBasis - bbDev

// ----- Keltner Channel -----
kcBasis = ta.ema(close, kcLen)
kcRange = ta.atr(kcLen) * kcMult
kcUpper = kcBasis + kcRange
kcLower = kcBasis - kcRange

// ----- Squeeze Detection -----
// 스퀴즈: BB가 KC 안에 있을 때
sqzOn  = bbLower > kcLower and bbUpper < kcUpper
sqzOff = not sqzOn

// 스퀴즈 해제 감지 (이번 봉에서 해제됨)
sqzRelease = sqzOff and sqzOn[1]

// ----- Momentum (Linear Regression) -----
// 가격이 평균에서 얼마나 벗어났는지 측정
src = close
mom = ta.linreg(src - ta.sma(src, momLen), momLen, 0)

// 모멘텀 방향
momUp   = mom > 0 and mom > mom[1]
momDown = mom < 0 and mom < mom[1]

// 강한 모멘텀 (가속 중)
momAccelUp   = mom > 0 and mom > mom[1] and mom[1] > mom[2]
momAccelDown = mom < 0 and mom < mom[1] and mom[1] < mom[2]

// ----- Trend Filter -----
trendEma = ta.ema(close, trendLen)
trendUp   = close > trendEma
trendDown = close < trendEma

trendOkLong  = not useTrend or trendUp
trendOkShort = not useTrend or trendDown

// ----- Entry Conditions -----
// 스퀴즈 해제 + 모멘텀 방향 + 트렌드 필터
longCond  = sqzRelease and momUp and trendOkLong and useLong
shortCond = sqzRelease and momDown and trendOkShort and useShort

// 또는: 스퀴즈 중 모멘텀 가속 시작 (더 공격적)
// longCond  = sqzOn and momAccelUp and trendOkLong and useLong
// shortCond = sqzOn and momAccelDown and trendOkShort and useShort

// ----- Cooldown -----
var int lastExitBar = na
if strategy.position_size == 0 and strategy.position_size[1] != 0
    lastExitBar := bar_index

cooldownOk = na(lastExitBar) or (bar_index - lastExitBar >= cooldownBars)

// ----- Position Sizing -----
riskAmount = strategy.equity * (riskPct / 100.0)

// ===== Entries =====
var float entryPrice = na
var float stopPrice  = na
var float tpPrice    = na

// Long Entry
if cooldownOk and longCond and strategy.position_size == 0
    entryPrice := close
    stopPrice  := close - (atr * slAtrMult)
    tpPrice    := close + (atr * tpAtrMult)

    stopDist = close - stopPrice
    qty = stopDist > syminfo.mintick ? riskAmount / stopDist : na

    if not na(qty) and qty > 0
        strategy.entry("Long", strategy.long, qty=qty)

        if useTrail
            strategy.exit("Long Exit", "Long",
                 stop=stopPrice,
                 limit=tpPrice,
                 trail_offset=atr * trailAtr / syminfo.mintick,
                 trail_points=atr * trailAtr / syminfo.mintick)
        else
            strategy.exit("Long Exit", "Long", stop=stopPrice, limit=tpPrice)

// Short Entry
if cooldownOk and shortCond and strategy.position_size == 0
    entryPrice := close
    stopPrice  := close + (atr * slAtrMult)
    tpPrice    := close - (atr * tpAtrMult)

    stopDist = stopPrice - close
    qty = stopDist > syminfo.mintick ? riskAmount / stopDist : na

    if not na(qty) and qty > 0
        strategy.entry("Short", strategy.short, qty=qty)

        if useTrail
            strategy.exit("Short Exit", "Short",
                 stop=stopPrice,
                 limit=tpPrice,
                 trail_offset=atr * trailAtr / syminfo.mintick,
                 trail_points=atr * trailAtr / syminfo.mintick)
        else
            strategy.exit("Short Exit", "Short", stop=stopPrice, limit=tpPrice)

// ===== Visuals =====
// Trend EMA
plot(useTrend ? trendEma : na, "Trend EMA", color=color.orange, linewidth=2)

// Bollinger Bands
plot(bbUpper, "BB Upper", color=color.new(color.blue, 60))
plot(bbLower, "BB Lower", color=color.new(color.blue, 60))

// Keltner Channel
plot(kcUpper, "KC Upper", color=color.new(color.red, 60))
plot(kcLower, "KC Lower", color=color.new(color.red, 60))

// Squeeze Status (배경색)
bgcolor(sqzOn ? color.new(color.yellow, 85) : na, title="Squeeze On")

// Entry Signals
plotshape(longCond and cooldownOk and strategy.position_size == 0,
     title="Long Signal",
     style=shape.triangleup,
     color=color.green,
     size=size.small,
     location=location.belowbar)

plotshape(shortCond and cooldownOk and strategy.position_size == 0,
     title="Short Signal",
     style=shape.triangledown,
     color=color.red,
     size=size.small,
     location=location.abovebar)

// ===== Momentum Histogram (별도 패널) =====
// 하단에 모멘텀 히스토그램 표시
momColor = mom > 0 ? (mom > mom[1] ? color.lime : color.green) :
                     (mom < mom[1] ? color.red : color.maroon)

plot(mom, "Momentum", color=momColor, style=plot.style_columns, histbase=0)

// ===== Info Table =====
var table infoTable = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80))

if barstate.islast
    // Header
    table.cell(infoTable, 0, 0, "Status", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Value", text_color=color.white, text_size=size.small)

    // Squeeze
    sqzText  = sqzOn ? "SQUEEZE" : "NO SQUEEZE"
    sqzColor = sqzOn ? color.yellow : color.gray
    table.cell(infoTable, 0, 1, "Squeeze", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 1, sqzText, text_color=sqzColor, text_size=size.small)

    // Momentum
    momText  = mom > 0 ? "Bullish" : "Bearish"
    momTColor = mom > 0 ? color.green : color.red
    table.cell(infoTable, 0, 2, "Momentum", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 2, momText, text_color=momTColor, text_size=size.small)

    // Trend
    trendText  = close > trendEma ? "Bullish" : "Bearish"
    trendColor = close > trendEma ? color.green : color.red
    table.cell(infoTable, 0, 3, "Trend", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 3, trendText, text_color=trendColor, text_size=size.small)

    // ATR %
    atrPct = atr / close * 100
    table.cell(infoTable, 0, 4, "ATR%", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(atrPct, "#.##") + "%", text_color=color.white, text_size=size.small)

    // Position
    posText = strategy.position_size > 0 ? "LONG" : strategy.position_size < 0 ? "SHORT" : "FLAT"
    posColor = strategy.position_size > 0 ? color.green : strategy.position_size < 0 ? color.red : color.gray
    table.cell(infoTable, 0, 5, "Position", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 5, posText, text_color=posColor, text_size=size.small)

// ===== Alerts =====
alertcondition(longCond and cooldownOk, "Long Signal", "Squeeze Momentum: Long Entry")
alertcondition(shortCond and cooldownOk, "Short Signal", "Squeeze Momentum: Short Entry")
alertcondition(sqzRelease, "Squeeze Release", "Volatility Squeeze Released!")
